<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Azure - InfrastructureAsCode on ManualBashing</title><link>https://manualbashing.github.io/tags/azure-infrastructureascode/</link><description>Recent content in Azure - InfrastructureAsCode on ManualBashing</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Fri, 17 Nov 2023 13:37:45 +0000</lastBuildDate><atom:link href="https://manualbashing.github.io/tags/azure-infrastructureascode/index.xml" rel="self" type="application/rss+xml"/><item><title>Keep your secrets out of your bicep parameters</title><link>https://manualbashing.github.io/posts/keep-your-secrets-out-of-your-bicep-parameters/</link><pubDate>Fri, 17 Nov 2023 13:37:45 +0000</pubDate><guid>https://manualbashing.github.io/posts/keep-your-secrets-out-of-your-bicep-parameters/</guid><description>&lt;p>Imagine the following scenario: We have to deploy an Azure Key Vault that comes already populated with a secret, let&amp;rsquo;s say, some third party&amp;rsquo;s API access key. Our bicep file (&lt;code>azuredeploy.bicep&lt;/code>) could look like this:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-json" data-lang="json">&lt;span style="display:flex;">&lt;span>&lt;span style="">param&lt;/span> &lt;span style="">location&lt;/span> &lt;span style="">string&lt;/span> &lt;span style="">=&lt;/span> &lt;span style="">resourceGroup().location&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">param&lt;/span> &lt;span style="">tenantId&lt;/span> &lt;span style="">string&lt;/span> &lt;span style="">=&lt;/span> &lt;span style="">tenant().tenantId&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">@secure()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">param&lt;/span> &lt;span style="">keyvaultSecretCatfunValue&lt;/span> &lt;span style="">string&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">var&lt;/span> &lt;span style="">name&lt;/span> &lt;span style="">=&lt;/span> &lt;span style="">&amp;#39;kv-$&lt;/span>{&lt;span style="">uniqueString(resourceGroup().id)&lt;/span>}&lt;span style="">&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">resource&lt;/span> &lt;span style="">keyVault&lt;/span> &lt;span style="">&amp;#39;Microsoft.KeyVault/vaults@&lt;/span>&lt;span style="color:#666">2019-09-01&lt;/span>&lt;span style="">&amp;#39;&lt;/span> &lt;span style="">=&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">name:&lt;/span> &lt;span style="">name&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">location:&lt;/span> &lt;span style="">location&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">properties:&lt;/span> &lt;span style="">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">tenantId:&lt;/span> &lt;span style="">tenantId&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">sku:&lt;/span> &lt;span style="">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">name:&lt;/span> &lt;span style="">&amp;#39;standard&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">family:&lt;/span> &lt;span style="">&amp;#39;A&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">accessPolicies:&lt;/span> []
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">resource&lt;/span> &lt;span style="">keyvaultSecretCatfun&lt;/span> &lt;span style="">&amp;#39;Microsoft.KeyVault/vaults/secrets@&lt;/span>&lt;span style="color:#666">2019-09-01&lt;/span>&lt;span style="">&amp;#39;&lt;/span> &lt;span style="">=&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">parent:&lt;/span> &lt;span style="">keyVault&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">name:&lt;/span> &lt;span style="">&amp;#39;Catfun&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">properties:&lt;/span> &lt;span style="">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">value:&lt;/span> &lt;span style="">keyvaultSecretCatfunValue&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>But how to we deploy this to Azure without entering the secret&amp;rsquo;s value every time we call &lt;code>az deployment&lt;/code>?&lt;/p>
&lt;h2 id="loading-individual-secrets-from-external-files">Loading individual secrets from external files&lt;/h2>
&lt;p>One trick that worked well for me so far, was to use an external text file, that would be excluded from version control.&lt;/p>
&lt;p>For this to work would create a file &lt;code>Catfun.secret&lt;/code> that contains the API secret and make sure, that it is excluded from version control via &lt;code>.gitignore&lt;/code>.&lt;/p>
&lt;p>This secret would then be loaded by the bicep template as the default value for the &lt;code>keyvaultSecretCatfunValue&lt;/code> parameter:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a2f">@secure&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#080;font-style:italic">#disable-next-line secure-parameter-default&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>param keyvaultSecretCatfunValue string &lt;span style="color:#666">=&lt;/span> loadTextContent(&lt;span style="color:#b44">&amp;#39;Catfun.secret&amp;#39;&lt;/span>)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>(We have to add &lt;code>#disable-next-line secure-parameter-default&lt;/code>) to ignore the warning, that secure parameters should not use default values. Our scenario is a reasonable exception to this rule.)&lt;/p>
&lt;p>&lt;img src="static/vscode-secrets-file.png" alt="Screenshot of vscode showing a gitignore file and the code from the code listing above">&lt;/p>
&lt;h2 id="loading-several-secrets-from-the-same-file">Loading several secrets from the same file&lt;/h2>
&lt;p>If you need to deploy several secrets in a secure way it is not necessary to create a secret file for each. Instead you can save your secrets in a json file, that can be parsed by bicep.&lt;/p>
&lt;p>The content of my &lt;code>MoreSecrets.json&lt;/code> file looks like this:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-json" data-lang="json">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#008000;font-weight:bold">&amp;#34;Catfun&amp;#34;&lt;/span>: &lt;span style="color:#b44">&amp;#34;MySuperSecretAPIKey!&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#008000;font-weight:bold">&amp;#34;Fishfun&amp;#34;&lt;/span>: &lt;span style="color:#b44">&amp;#34;TheSameButBetter##!&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The file can then be parsed using the &lt;code>loadJsonContent()&lt;/code> function in bicep:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span>param location string &lt;span style="color:#666">=&lt;/span> resourceGroup()&lt;span style="color:#666">.&lt;/span>location
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>param tenantId string &lt;span style="color:#666">=&lt;/span> tenant()&lt;span style="color:#666">.&lt;/span>tenantId
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a2f">@secure&lt;/span>()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#080;font-style:italic">#disable-next-line secure-parameter-default&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>param secrets &lt;span style="color:#a2f">object&lt;/span> &lt;span style="color:#666">=&lt;/span> loadJsonContent(&lt;span style="color:#b44">&amp;#39;MoreFun.secret&amp;#39;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>var name &lt;span style="color:#666">=&lt;/span> &lt;span style="color:#b44">&amp;#39;kv-${uniqueString(resourceGroup().id)}&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>resource keyVault &lt;span style="color:#b44">&amp;#39;Microsoft.KeyVault/vaults@2019-09-01&amp;#39;&lt;/span> &lt;span style="color:#666">=&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name: name
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> location: location
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> properties: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> tenantId: tenantId
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sku: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name: &lt;span style="color:#b44">&amp;#39;standard&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> family: &lt;span style="color:#b44">&amp;#39;A&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> accessPolicies: []
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>resource keyvaultSecretCatfun &lt;span style="color:#b44">&amp;#39;Microsoft.KeyVault/vaults/secrets@2019-09-01&amp;#39;&lt;/span> &lt;span style="color:#666">=&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> parent: keyVault
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name: &lt;span style="color:#b44">&amp;#39;Catfun&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> properties: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> value: secrets&lt;span style="color:#666">.&lt;/span>Catfun
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>resource keyvaultSecretFishfun &lt;span style="color:#b44">&amp;#39;Microsoft.KeyVault/vaults/secrets@2019-09-01&amp;#39;&lt;/span> &lt;span style="color:#666">=&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> parent: keyVault
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name: &lt;span style="color:#b44">&amp;#39;Fishfun&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> properties: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> value: secrets&lt;span style="color:#666">.&lt;/span>Fishfun
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="protect-your-local-secret-files">Protect your local secret files&lt;/h2>
&lt;p>So far we have managed to keep our secrets out of version control, but they are still laying around in plain text files, which is not what we want for any type of secret.&lt;/p>
&lt;p>One way I like to do this is by encrypting the secrets using the &lt;a href="https://marketplace.visualstudio.com/items?itemName=ugosan.vscode-openpgp">OpenPGP extension&lt;/a> in vscode (&lt;code>ugosan.vscode-openpgp&lt;/code>).&lt;/p>
&lt;p>This allows me to protect the files that contain the secrets using a private key and passphrase.&lt;/p>
&lt;p>&lt;img src="static/secrets-gpg-animation.gif" alt="An animation showing how a encrypted file is decrypted with a passphrase">&lt;/p></description></item></channel></rss>