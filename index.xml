<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>ManualBashing</title><link>https://manualbashing.github.io/</link><description>Recent content on ManualBashing</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Thu, 09 Mar 2023 15:30:37 +0200</lastBuildDate><atom:link href="https://manualbashing.github.io/index.xml" rel="self" type="application/rss+xml"/><item><title>How to export csv watchlists from Azure Sentinel</title><link>https://manualbashing.github.io/posts/how-to-export-csv-watchlists-from-azure-sentinel/</link><pubDate>Thu, 09 Mar 2023 15:30:37 +0200</pubDate><guid>https://manualbashing.github.io/posts/how-to-export-csv-watchlists-from-azure-sentinel/</guid><description>&lt;p>Azure Sentinel is Microsoft&amp;rsquo;s &lt;em>Security Information and Event Management&lt;/em> (SIEM) tool, that helps to identify security threats and to respond quickly when they occur. One could say that it is an organization&amp;rsquo;s enhanced ears and eyes, like.. you know:&lt;/p>
&lt;p>&lt;a href="https://en.wikipedia.org/wiki/The_Sentinel_(TV_series)">&lt;img src="https://manualbashing.github.io/static/the-sentinel.png" alt="The Sentinel">&lt;/a>&lt;/p>
&lt;p>Sentinel supports so called watchlists. Watchlists are csv files, that add custom information to the assets that you want to monitor closely.&lt;/p>
&lt;p>Creating and uploading watchlists is a piece of cake and can be done in the Azure Portal: &lt;a href="https://learn.microsoft.com/en-us/azure/sentinel/watchlists-create">Create watchlists - Microsoft Sentinel | Microsoft Learn&lt;/a>.&lt;/p>
&lt;p>But what if you need to download an existing watchlist? This appears to be unreasonably difficult. At the time of this writing there is no download button in the Azure Portal. And the &lt;a href="https://learn.microsoft.com/en-us/cli/azure/service-page/microsoft%20sentinel?view=azure-cli-latest">Azure CLI extention for Sentinel&lt;/a> doesn&amp;rsquo;t offer this option either.&lt;/p>
&lt;p>Fortunately the Azure Management REST API allows us to work around this limitation.&lt;/p>
&lt;h2 id="export-csv-watchlists-using-the-rest-api">Export csv watchlists using the REST API&lt;/h2>
&lt;p>There is an API method, that allows us to list the contents of the Sentinel watchlists in JSON format: &lt;a href="https://learn.microsoft.com/en-us/rest/api/securityinsights/preview/watchlist-items/list?tabs=HTTP">Watchlist Items - List - REST API (Azure Sentinel) | Microsoft Learn&lt;/a>.&lt;/p>
&lt;p>The only thing we need to do is to translate this output into the schema of the CSV files that Sentinel supports. This can be done with the following PowerShell cmdlet.&lt;/p>
&lt;script type="application/javascript" src="https://gist.github.com/manualbashing/d52f7a74e03a2942628caa45fe3c8f65.js">&lt;/script>
&lt;p>&lt;a href="https://gist.github.com/manualbashing/d52f7a74e03a2942628caa45fe3c8f65">Export-SentinelWatchlist.ps1&lt;/a>&lt;/p>
&lt;p>To run this cmdlet the following requirements need to be met:&lt;/p>
&lt;ul>
&lt;li>It needs to be run in PowerShell Core&lt;/li>
&lt;li>The Az PowerShell module is installed&lt;/li>
&lt;li>You are connected to the correct Azure subscription with the Az PowerShell module (Run &lt;code>Get-AzContext&lt;/code> to check).&lt;/li>
&lt;/ul>
&lt;p>You can run this cmdlet for example like this:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>. ./&lt;span style="color:#a2f">Export-SentinelWatchlist&lt;/span>.ps1 &lt;span style="color:#080;font-style:italic"># dotsourcing the file that contains the cmdlet&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a2f">Export-SentinelWatchlist&lt;/span> -ResourceGroupName &lt;span style="color:#b44">&amp;#39;rg-sentinel&amp;#39;&lt;/span> -WorkspaceName &lt;span style="color:#b44">&amp;#39;sws-sentinel-workspace&amp;#39;&lt;/span> -WatchlistName &lt;span style="color:#b44">&amp;#39;Customer&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>dotnet SDK not found in VSCode Dev Container Ubuntu Jammy (22.04)</title><link>https://manualbashing.github.io/posts/dotnet-fails-in-devcontainer/</link><pubDate>Wed, 24 Aug 2022 14:37:45 +0200</pubDate><guid>https://manualbashing.github.io/posts/dotnet-fails-in-devcontainer/</guid><description>&lt;p>A couple of days ago, some of my &lt;a href="https://code.visualstudio.com/docs/remote/containers">vscode dev containers&lt;/a> suddenly failed to build. Here is a minimal example:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-Dockerfile" data-lang="Dockerfile">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a2f;font-weight:bold">FROM&lt;/span>&lt;span style="color:#b44"> mcr.microsoft.com/vscode/devcontainers/base:0-jammy&lt;/span>&lt;span style="">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">&lt;/span>&lt;span style="color:#a2f;font-weight:bold">SHELL&lt;/span> [&lt;span style="color:#b44">&amp;#34;/bin/bash&amp;#34;&lt;/span>, &lt;span style="color:#b44">&amp;#34;-lc&amp;#34;&lt;/span>]&lt;span style="">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">&lt;/span>&lt;span style="color:#a2f;font-weight:bold">RUN&lt;/span> wget https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb -q &lt;span style="color:#b62;font-weight:bold">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b62;font-weight:bold">&lt;/span>  &lt;span style="color:#666">&amp;amp;&amp;amp;&lt;/span> dpkg -i packages-microsoft-prod.deb &lt;span style="color:#b62;font-weight:bold">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b62;font-weight:bold">&lt;/span>  &lt;span style="color:#666">&amp;amp;&amp;amp;&lt;/span> rm packages-microsoft-prod.deb&lt;span style="">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">&lt;/span>&lt;span style="color:#a2f;font-weight:bold">RUN&lt;/span> apt update &lt;span style="color:#b62;font-weight:bold">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b62;font-weight:bold">&lt;/span> &lt;span style="color:#666">&amp;amp;&amp;amp;&lt;/span> apt install -y --no-install-recommends dotnet-sdk-6.0&lt;span style="">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">&lt;/span>&lt;span style="color:#a2f;font-weight:bold">RUN&lt;/span> dotnet tool install -g Microsoft.dotnet-interactive&lt;span style="">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This was working fine before, but now I got the following error message:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-text" data-lang="text">&lt;span style="display:flex;">&lt;span>Step 5/5 : RUN dotnet tool install -g Microsoft.dotnet-interactive
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ---&amp;gt; Running in 52e362723554
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>The command could not be loaded, possibly because:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> * You intended to execute a .NET application:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> The application &amp;#39;tool&amp;#39; does not exist.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> * You intended to execute a .NET SDK command:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> No .NET SDKs were found.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>As far as I understood the problem here is, that the &lt;code>dotnet-sdk-6.0&lt;/code> package and its dependencies are now available in both, the Ubuntu and the Microsoft repository, but their install locations are different. This will mess up the installation, if packages are picked from both feeds.&lt;/p>
&lt;p>See here for more information:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/dotnet/sdk/issues/27082">[Ubuntu 22.04] dotnet doesn&amp;rsquo;t find installed SDKs · Issue #27082 · dotnet/sdk · GitHub&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/dotnet/core/issues/7699">Installing .NET 6 on Ubuntu 22.04 (Jammy) · Issue #7699 · dotnet/core · GitHub&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>A workaround to this issue is to use apt&amp;rsquo;s &lt;a href="https://help.ubuntu.com/community/PinningHowto">pinning mechanism&lt;/a> to set the Microsoft feed as the preferred repository. This means apt will try to install a package from the Microsoft feed first and then fall back to the distribution repository, if the package is not available.&lt;/p>
&lt;p>To configure a preference, create a file called &lt;code>apt-preference&lt;/code> in your &lt;code>.devcontainer&lt;/code> folder and add the following content:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-text" data-lang="text">&lt;span style="display:flex;">&lt;span>Package: *
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Pin: origin &amp;#34;packages.microsoft.com&amp;#34;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Pin-Priority: 1001
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Then add a copy statement to your Dockerfile to use this file as your configuration for apt pins.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-Dockerfile" data-lang="Dockerfile">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#a2f;font-weight:bold">FROM&lt;/span>&lt;span style="color:#b44"> mcr.microsoft.com/vscode/devcontainers/base:0-jammy&lt;/span>&lt;span style="">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">&lt;/span>&lt;span style="color:#a2f;font-weight:bold">SHELL&lt;/span> [&lt;span style="color:#b44">&amp;#34;/bin/bash&amp;#34;&lt;/span>, &lt;span style="color:#b44">&amp;#34;-lc&amp;#34;&lt;/span>]&lt;span style="">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">&lt;/span>&lt;span style="color:#a2f;font-weight:bold">RUN&lt;/span> wget https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb -q &lt;span style="color:#b62;font-weight:bold">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b62;font-weight:bold">&lt;/span>  &lt;span style="color:#666">&amp;amp;&amp;amp;&lt;/span> dpkg -i packages-microsoft-prod.deb &lt;span style="color:#b62;font-weight:bold">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b62;font-weight:bold">&lt;/span>  &lt;span style="color:#666">&amp;amp;&amp;amp;&lt;/span> rm packages-microsoft-prod.deb&lt;span style="">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">&lt;/span>&lt;span style="color:#a2f;font-weight:bold">COPY&lt;/span> ./apt-preferences /etc/apt/preferences&lt;span style="">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">&lt;/span>&lt;span style="color:#a2f;font-weight:bold">RUN&lt;/span> apt update &lt;span style="color:#b62;font-weight:bold">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b62;font-weight:bold">&lt;/span> &lt;span style="color:#666">&amp;amp;&amp;amp;&lt;/span> apt install -y --no-install-recommends dotnet-sdk-6.0&lt;span style="">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">&lt;/span>&lt;span style="color:#a2f;font-weight:bold">RUN&lt;/span> dotnet tool install -g Microsoft.dotnet-interactive&lt;span style="">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title> Query Azure Log Analytics from Logic App using Managed Identity</title><link>https://manualbashing.github.io/posts/logicapp-loganalytics-mi/</link><pubDate>Fri, 01 Apr 2022 17:15:55 +0200</pubDate><guid>https://manualbashing.github.io/posts/logicapp-loganalytics-mi/</guid><description>&lt;p>While &lt;a href="https://docs.microsoft.com/en-us/azure/azure-monitor/logs/log-analytics-workspace-overview">Azure Log Analytics Workspaces&lt;/a> supports access using a &lt;a href="https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview">Managed Identity&lt;/a> (formally known as: Managed Service Identity, MSI), the official &lt;a href="https://docs.microsoft.com/en-us/azure/azure-monitor/logs/logicapp-flow-connector">Logic Apps connector for Azure Log Analytics (Azure Monitor Logs)&lt;/a> does not.&lt;/p>
&lt;p>As a workaround queries to a Log Analytics Workspace can also be send directly to the &lt;a href="https://docs.microsoft.com/en-us/rest/api/loganalytics/">Azure REST API&lt;/a>, as the built-in HTTP connector in Logic Apps supports Managed Identities.&lt;/p>
&lt;p>&lt;img src="https://manualbashing.github.io/static/logicapp-workspace-msi.png" alt="">&lt;/p>
&lt;p>I have added a minimal example to my bicep-snippets repository: &lt;a href="https://github.com/manualbashing/bicep-snippets/tree/mother/logicapp-msi-workspace">bicep-snippets/logicapp-msi-workspace at mother · manualbashing/bicep-snippets (github.com)&lt;/a>&lt;/p></description></item><item><title>Watch out for EOL characters when using the base64 tool with stdin</title><link>https://manualbashing.github.io/posts/base64-stdin/</link><pubDate>Wed, 30 Mar 2022 15:11:53 +0100</pubDate><guid>https://manualbashing.github.io/posts/base64-stdin/</guid><description>&lt;p>In a Linux environment, the &lt;a href="http://manpages.ubuntu.com/manpages/bionic/man1/base64.1.html">base64 tool&lt;/a> can be used to base64 encode or decode data. If called directly the tool expects a file path but it is also possible to use stdin. This means we can use &lt;code>echo&lt;/code> or &lt;code>printf&lt;/code> together with a pipe to encode (or decode) a string without writing it to a file first.&lt;/p>
&lt;p>But be careful which command you use! The same string &lt;code>'foobar'&lt;/code> will result in a different base64 encoded string, depending on whether &lt;code>echo&lt;/code> or &lt;code>printf&lt;/code> was used:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>❯ &lt;span style="color:#a2f">echo&lt;/span> &lt;span style="color:#b44">&amp;#39;foobar&amp;#39;&lt;/span> | base64
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b8860b">Zm9vYmFyCg&lt;/span>&lt;span style="color:#666">==&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>❯ &lt;span style="color:#a2f">printf&lt;/span> &lt;span style="color:#b44">&amp;#39;foobar&amp;#39;&lt;/span> | base64
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Zm9vYmFy
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>But why is that so? The short answer: &lt;a href="https://linuxhint.com/printf-vs-echo-bash">echo always adds an end-of-line character to the string&lt;/a>, and this character gets encoded too in the base64 string.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>❯ &lt;span style="color:#a2f">echo&lt;/span> &lt;span style="color:#b44">&amp;#39;foobar&amp;#39;&lt;/span> | od -c
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">0000000&lt;/span> f o o b a r &lt;span style="color:#b62;font-weight:bold">\n&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">0000007&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>❯ &lt;span style="color:#a2f">printf&lt;/span> &lt;span style="color:#b44">&amp;#39;foobar&amp;#39;&lt;/span> | od -c
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">0000000&lt;/span> f o o b a r
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">0000006&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The end-of-line character is not only added by &lt;code>echo&lt;/code>. Using the &lt;code>&amp;lt;&amp;lt;&amp;lt;&lt;/code> redirection also has this effect.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>❯ &lt;span style="color:#b8860b">encodedString&lt;/span>&lt;span style="color:#666">=&lt;/span>&lt;span style="color:#a2f;font-weight:bold">$(&lt;/span> base64 &lt;span style="color:#666">&amp;lt;&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#b44">&amp;#39;foobar&amp;#39;&lt;/span> &lt;span style="color:#a2f;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>❯ base64 --decode &lt;span style="color:#666">&amp;lt;&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#b8860b">$encodedString&lt;/span> | od -c
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">0000000&lt;/span> f o o b a r &lt;span style="color:#b62;font-weight:bold">\n&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">0000007&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;p>&lt;strong>🧐 And because it can&amp;rsquo;t be mentioned often enough:&lt;/strong> &amp;ldquo;Base64 is an encoding, &lt;a href="https://base64.guru/blog/base64-encryption-is-a-lie">not an encryption&lt;/a>&amp;rdquo;.
&lt;img src="https://manualbashing.github.io/static/base64.jpg" alt="">&lt;/p></description></item><item><title>Issues with Terraform and WSL: Unable to list provider registration status</title><link>https://manualbashing.github.io/posts/terraform-wsl/</link><pubDate>Thu, 24 Feb 2022 11:03:43 +0100</pubDate><guid>https://manualbashing.github.io/posts/terraform-wsl/</guid><description>&lt;h2 id="the-problem">The problem&lt;/h2>
&lt;p>Today, something weird happened when I was using terraform in my WSL2 to deploy some infrastructure to Azure. I was initializing terraform, typed:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>terraform plan
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>And&amp;hellip; nothing happened.&lt;/p>
&lt;p>&lt;img src="https://manualbashing.github.io/static/10minuteslater.png" alt="10 minutes later">&lt;/p>
&lt;p>After waiting a small eternity the following error popped up on my console:&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>Error: Unable to list provider registration status; it is possible that this is due to invalid credentials or the service principal does not have permission to use the Resource Manager API&lt;/strong>, Azure error: resources. ProvidersClient#List: Failure sending request: StatusCode=0 &amp;ndash; Original Error: Get &amp;ldquo;&lt;a href="https://management.azure.com/subscriptions/xxxxx-xxxx-xxxx-xxxx-xxxxxxxx/providers?api-version=2016-02-01%22:%22">https://management.azure.com/subscriptions/xxxxx-xxxx-xxxx-xxxx-xxxxxxxx/providers?api-version=2016-02-01%22:&amp;quot;&lt;/a> dial tcp: lookup management.azure.com on 172.23.224.1:53: &lt;strong>cannot unmarshal DNS message&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;h2 id="the-cause">The cause&lt;/h2>
&lt;p>What was going on? Apparently, &lt;code>azurerm&lt;/code> (Terraform&amp;rsquo;s provider for Azure Resource Manager) tried to resolve the hostname &lt;code>management.azure.com&lt;/code> and was not happy with the response.&lt;/p>
&lt;p>After some excessive googling and GitHub-issue browsing, I finally hit gold: &lt;a href="https://github.com/golang/go/issues/51127#issue-1129393515">net: 512 byte DNS response size limit causes an error when making requests to Azure on WSL2 · Issue #51127 · golang/go (github.com)&lt;/a>&lt;/p>
&lt;p>The azurerm provider was written in Golang, and apparently, Golang&amp;rsquo;s net/dns resolver applies a strict 512-byte limit to the response buffer. If the response exceeds that limit, the resolver will not be able to &amp;ldquo;unmarshal the DNS message&amp;rdquo;.&lt;/p>
&lt;p>A quick &lt;code>dig&lt;/code> affirmed all suspicions:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>❯ dig management.azure.com
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>; &amp;lt;&amp;lt;&amp;gt;&amp;gt; DiG 9.16.1-Ubuntu &amp;lt;&amp;lt;&amp;gt;&amp;gt; management.azure.com
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>;; global options: +cmd
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>;; Got answer:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>;; -&amp;gt;&amp;gt;HEADER&lt;span style="color:#b44">&amp;lt;&amp;lt;- opco&lt;/span>de: QUERY, status: NOERROR, id: &lt;span style="color:#666">20748&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>;; flags: qr rd ad; QUERY: 1, ANSWER: 7, AUTHORITY: 0, ADDITIONAL: &lt;span style="color:#666">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>;; WARNING: recursion requested but not available
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>;; QUESTION SECTION:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>;management.azure.com. IN A
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>;; ANSWER SECTION:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>management.azure.com. &lt;span style="color:#666">0&lt;/span> IN CNAME management.privatelink.azure.com.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>management.privatelink.azure.com. &lt;span style="color:#666">0&lt;/span> IN CNAME arm-frontdoor-prod.trafficmanager.net.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>arm-frontdoor-prod.trafficmanager.net. &lt;span style="color:#666">0&lt;/span> IN CNAME germanywestcentral.management.azure.com.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>germanywestcentral.management.azure.com. &lt;span style="color:#666">0&lt;/span> IN CNAME arm-frontdoor-germanywestcentral.trafficmanager.net.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>arm-frontdoor-germanywestcentral.trafficmanager.net. &lt;span style="color:#666">0&lt;/span> IN CNAME germanywestcentral.cs.management.azure.com.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>germanywestcentral.cs.management.azure.com. &lt;span style="color:#666">0&lt;/span> IN CNAME rpfd-germanywestcentral.cloudapp.net.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rpfd-germanywestcentral.cloudapp.net. &lt;span style="color:#666">0&lt;/span> IN A 51.116.156.32
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>;; Query time: &lt;span style="color:#666">40&lt;/span> msec
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>;; SERVER: 172.18.96.1#53&lt;span style="color:#666">(&lt;/span>172.18.96.1&lt;span style="color:#666">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>;; WHEN: Thu Feb &lt;span style="color:#666">24&lt;/span> 21:09:39 CET &lt;span style="color:#666">2022&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>;; MSG SIZE rcvd: &lt;span style="color:#666">632&lt;/span> 👈
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Indeed, the response size was 632 bytes. &lt;strong>But why did it work in the past?&lt;/strong> According to AaronFriel (see link above), Microsoft only recently added additional cnames to their management.azure.com endpoint, pushing the response size over the 512-byte limit.&lt;/p>
&lt;p>&lt;strong>Why is this happening only in WSL2?&lt;/strong> Per default, WSL2 uses the DNS configuration of the Hyper-V Virtual Network Adapter. This DNS server adds additional data to the ANSWER section of the response: &lt;a href="https://github.com/microsoft/WSL/issues/5806">DNS server mixes AUTHORITY/ADDITIONAL section into ANSWER section while responding to queries · Issue #5806 · microsoft/WSL (github.com)&lt;/a>&lt;/p>
&lt;h2 id="the-workaround">The workaround&lt;/h2>
&lt;p>What worked for me was forcing WSL2 to use an external DNS resolver like Google (&lt;code>8.8.8.8&lt;/code>) or UltraDNS (&lt;code>64.6.64.6&lt;/code>):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>❯ dig management.azure.com @64.6.64.6
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>; &amp;lt;&amp;lt;&amp;gt;&amp;gt; DiG 9.16.1-Ubuntu &amp;lt;&amp;lt;&amp;gt;&amp;gt; management.azure.com @64.6.64.6
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>;; global options: +cmd
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>;; Got answer:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>;; -&amp;gt;&amp;gt;HEADER&lt;span style="color:#b44">&amp;lt;&amp;lt;- opcode: QUERY, status: NOERROR, id: 2007
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b44">;; flags: qr rd ra; QUERY: 1, ANSWER: 7, AUTHORITY: 0, ADDITIONAL: 1
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b44">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b44">;; OPT PSEUDOSECTION:
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b44">; EDNS: version: 0, flags:; udp: 4096
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b44">;; QUESTION SECTION:
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b44">;management.azure.com. IN A
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b44">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b44">;; ANSWER SECTION:
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b44">management.azure.com. 424 IN CNAME management.privatelink.azure.com.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b44">management.privatelink.azure.com. 3002 IN CNAME arm-frontdoor-prod.trafficmanager.net.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b44">arm-frontdoor-prod.trafficmanager.net. 40 IN CNAME westeurop&lt;/span>e.management.azure.com.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>westeurope.management.azure.com. &lt;span style="color:#666">2516&lt;/span> IN CNAME arm-frontdoor-westeurope.trafficmanager.net.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>arm-frontdoor-westeurope.trafficmanager.net. &lt;span style="color:#666">40&lt;/span> IN CNAME westeurope.cs.management.azure.com.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>westeurope.cs.management.azure.com. &lt;span style="color:#666">742&lt;/span> IN CNAME rpfd-prod-am-01.cloudapp.net.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>rpfd-prod-am-01.cloudapp.net. &lt;span style="color:#666">10&lt;/span> IN A 13.69.114.0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>;; Query time: &lt;span style="color:#666">40&lt;/span> msec
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>;; SERVER: 64.6.64.6#53&lt;span style="color:#666">(&lt;/span>64.6.64.6&lt;span style="color:#666">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>;; WHEN: Thu Feb &lt;span style="color:#666">24&lt;/span> 21:30:11 CET &lt;span style="color:#666">2022&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>;; MSG SIZE rcvd: &lt;span style="color:#666">284&lt;/span> 👈
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>That brought the response down to a size the resolver in Golang could digest.&lt;/p>
&lt;p>The DNS server in WSL2 is configured in the &lt;code>/etc/resolv.conf&lt;/code>, which WSL2 generates on every boot. Changing anything here will not persist.&lt;/p>
&lt;p>You first need to tell WSL2 not to touch the file. Add the following to &lt;code>/etc/wsl.conf&lt;/code> (if the file does not exist, feel free to create it):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">[&lt;/span>network&lt;span style="color:#666">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b8860b">generateResolvConf&lt;/span> &lt;span style="color:#666">=&lt;/span> &lt;span style="color:#a2f">false&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now restart your WSL2 by typing &lt;code>wsl.exe --shutdown&lt;/code> in the cmd command prompt. After WSL2 has started again, remove the sad remains of &lt;code>/etc/resolv.conf&lt;/code> (it is a symlink now, that does not point anywhere anymore):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>sudo rm /etc/resolv.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now add an external nameserver of your choice to the file:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a2f">echo&lt;/span> &lt;span style="color:#b44">&amp;#39;nameserver 64.6.64.6&amp;#39;&lt;/span> | sudo tee -a /etc/resolv.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>And that&amp;rsquo;s it! After this change, terraform worked again in WSL2.&lt;/p></description></item><item><title>Use PowerShell to sort version strings</title><link>https://manualbashing.github.io/posts/sort-version-strings/</link><pubDate>Mon, 14 Feb 2022 12:50:28 +0100</pubDate><guid>https://manualbashing.github.io/posts/sort-version-strings/</guid><description>&lt;p>When sorting or comparing version numbers in PowerShell (to determine the latest version of a release, etc.), be careful not to work with plain version strings.&lt;/p>
&lt;p>PowerShell sorts strings in a lexical way, which means that it compares strings character by character to determine the sort order. This works well for words: &lt;code>fool&lt;/code> will come after &lt;code>foo&lt;/code> but before &lt;code>fox&lt;/code>. This does not work well for version strings:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>&lt;span style="">❯&lt;/span> &lt;span style="color:#b44">&amp;#39;1.0.0&amp;#39;&lt;/span>, &lt;span style="color:#b44">&amp;#39;0.50.0&amp;#39;&lt;/span>, &lt;span style="color:#b44">&amp;#39;0.5.339&amp;#39;&lt;/span>, &lt;span style="color:#b44">&amp;#39;0.6.0&amp;#39;&lt;/span> | &lt;span style="color:#a2f">Sort-Object&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">0.5&lt;/span>.339
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">0.50&lt;/span>.0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">0.6&lt;/span>.0 &lt;span style="">👈&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">1.0&lt;/span>.0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="use-the-version-type">Use the [version] type&lt;/h2>
&lt;p>In PowerShell version, strings can be cast to the &lt;code>version&lt;/code> type which does all the heavy lifting parsing version strings into objects:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>&lt;span style="">❯&lt;/span> &lt;span style="color:#b44">&amp;#39;1.4.56&amp;#39;&lt;/span> &lt;span style="color:#666">-as&lt;/span> [&lt;span style="color:#800">version&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Major Minor Build Revision
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>----- ----- ----- --------
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">1&lt;/span> &lt;span style="color:#666">4&lt;/span> &lt;span style="color:#666">56&lt;/span> &lt;span style="color:#666">-1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The version type has its own comparsion logic already implemented:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>&lt;span style="">❯&lt;/span> &lt;span style="color:#b44">&amp;#39;0.50.0&amp;#39;&lt;/span> &lt;span style="color:#666">-gt&lt;/span> &lt;span style="color:#b44">&amp;#39;0.6.0&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>False
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="">❯&lt;/span> [&lt;span style="color:#800">version&lt;/span>]&lt;span style="color:#b44">&amp;#39;0.50.0&amp;#39;&lt;/span> &lt;span style="color:#666">-gt&lt;/span> [&lt;span style="color:#800">version&lt;/span>]&lt;span style="color:#b44">&amp;#39;0.6.0&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>True
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>And we can use this for sorting:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>&lt;span style="">❯&lt;/span> &lt;span style="color:#b44">&amp;#39;1.0.0&amp;#39;&lt;/span>, &lt;span style="color:#b44">&amp;#39;0.50.0&amp;#39;&lt;/span>, &lt;span style="color:#b44">&amp;#39;0.5.339&amp;#39;&lt;/span>, &lt;span style="color:#b44">&amp;#39;0.6.0&amp;#39;&lt;/span> | &lt;span style="color:#a2f">Sort-Object&lt;/span> { &lt;span style="color:#b8860b">$_&lt;/span> &lt;span style="color:#666">-as&lt;/span> [&lt;span style="color:#800">version&lt;/span>] }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">0.5&lt;/span>.339
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">0.6&lt;/span>.0 &lt;span style="">👈&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">0.50&lt;/span>.0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">1.0&lt;/span>.0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="sort-version-strings-with-postfix">Sort version strings with postfix&lt;/h2>
&lt;p>This method will not work if the version string has a postfix like &lt;code>-preview&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>&lt;span style="">❯&lt;/span> &lt;span style="color:#b44">&amp;#39;1.0.0&amp;#39;&lt;/span>, &lt;span style="color:#b44">&amp;#39;0.50.0&amp;#39;&lt;/span>, &lt;span style="color:#b44">&amp;#39;0.5.339&amp;#39;&lt;/span>, &lt;span style="color:#b44">&amp;#39;0.6.0-preview&amp;#39;&lt;/span> | &lt;span style="color:#a2f">Sort-Object&lt;/span> { &lt;span style="color:#b8860b">$_&lt;/span> &lt;span style="color:#666">-as&lt;/span> [&lt;span style="color:#800">version&lt;/span>] }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">0.6&lt;/span>.&lt;span style="color:#666">0&lt;/span>-preview &lt;span style="">👈&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">0.5&lt;/span>.339
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">0.50&lt;/span>.0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">1.0&lt;/span>.0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This happens because the string &lt;code>0.6.0-preview&lt;/code> fails the cast to &lt;code>[version]&lt;/code>, so &lt;code>Sort-Object&lt;/code> has no idea what to do with it. (Depending on your PowerShell version the last command might cause an exception. In my version 7.2.1 it fails silently.)&lt;/p>
&lt;p>One way to work around this issue is to use a regex to strip the postfix from the version string before casting it to &lt;code>[version]&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>&lt;span style="">❯&lt;/span> &lt;span style="color:#b44">&amp;#39;1.0.0&amp;#39;&lt;/span>, &lt;span style="color:#b44">&amp;#39;0.50.0&amp;#39;&lt;/span>, &lt;span style="color:#b44">&amp;#39;0.5.339&amp;#39;&lt;/span>, &lt;span style="color:#b44">&amp;#39;0.6.0-preview&amp;#39;&lt;/span>, &lt;span style="color:#b44">&amp;#39;0.6.0&amp;#39;&lt;/span>, &lt;span style="color:#b44">&amp;#39;0.6.0-lts&amp;#39;&lt;/span> |
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a2f">Sort-Object&lt;/span> { (&lt;span style="color:#b8860b">$_&lt;/span> &lt;span style="color:#666">-replace&lt;/span> &lt;span style="color:#b44">&amp;#39;-.+$&amp;#39;&lt;/span>) &lt;span style="color:#666">-as&lt;/span> [&lt;span style="color:#800">version&lt;/span>] }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">0.5&lt;/span>.339
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">0.6&lt;/span>.&lt;span style="color:#666">0&lt;/span>-preview &lt;span style="">👈&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">0.6&lt;/span>.0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">0.6&lt;/span>.&lt;span style="color:#666">0&lt;/span>-lts &lt;span style="">👈&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">0.50&lt;/span>.0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">1.0&lt;/span>.0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>But here we see a new problem: there is no inner sort for the same version number with different postfixes. This happens in our example, because &lt;code>Sort-Object&lt;/code> never gets to see the postfix.&lt;/p>
&lt;p>Fortunately &lt;code>Sort-Object&lt;/code> allows us to specify an inner sort using a second scriptblock:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-powershell" data-lang="powershell">&lt;span style="display:flex;">&lt;span>&lt;span style="">❯&lt;/span> &lt;span style="color:#b44">&amp;#39;1.0.0&amp;#39;&lt;/span>, &lt;span style="color:#b44">&amp;#39;0.50.0&amp;#39;&lt;/span>, &lt;span style="color:#b44">&amp;#39;0.5.339&amp;#39;&lt;/span>, &lt;span style="color:#b44">&amp;#39;0.6.0-preview&amp;#39;&lt;/span>, &lt;span style="color:#b44">&amp;#39;0.6.0&amp;#39;&lt;/span>, &lt;span style="color:#b44">&amp;#39;0.6.0-lts&amp;#39;&lt;/span> |
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a2f">Sort-Object&lt;/span> { (&lt;span style="color:#b8860b">$_&lt;/span> &lt;span style="color:#666">-replace&lt;/span> &lt;span style="color:#b44">&amp;#39;-.+$&amp;#39;&lt;/span>) &lt;span style="color:#666">-as&lt;/span> [&lt;span style="color:#800">version&lt;/span>] }, { &lt;span style="color:#b8860b">$_&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">0.5&lt;/span>.339
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">0.6&lt;/span>.0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">0.6&lt;/span>.&lt;span style="color:#666">0&lt;/span>-lts
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">0.6&lt;/span>.&lt;span style="color:#666">0&lt;/span>-preview
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">0.50&lt;/span>.0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">1.0&lt;/span>.0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>How to restore or purge a soft-deleted Azure API management service instance</title><link>https://manualbashing.github.io/posts/soft-deleted-apim/</link><pubDate>Thu, 10 Feb 2022 00:00:00 +0000</pubDate><guid>https://manualbashing.github.io/posts/soft-deleted-apim/</guid><description>&lt;blockquote>
&lt;p>&lt;strong>Edit 2023-02-17&lt;/strong>: The approach described below is not necessary anymore. Current versions of &lt;em>azure CLI&lt;/em> (f.e. 2.45.0+) provide commands to identify and remove soft deleted apim instances:&lt;/p>
&lt;ul>
&lt;li>List: &lt;code>az apim deletedservice list&lt;/code>&lt;/li>
&lt;li>Remove: &lt;code>az apim deletedservice purge --service-name &amp;quot;{name}&amp;quot; -l {location}&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>See here for more information: &lt;a href="https://learn.microsoft.com/en-us/cli/azure/apim/deletedservice?view=azure-cli-latest">az apim deletedservice&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;p>Starting with REST API version, &lt;code>2020-06-01-preview&lt;/code> , Microsoft introduced the soft-delete feature to API Management service (APIM) (See: &lt;a href="https://docs.microsoft.com/en-us/azure/api-management/soft-delete">Azure API Management soft-delete (preview) | Microsoft Docs&lt;/a>)&lt;/p>
&lt;p>Deleting an APIM using the REST API version &lt;code>2020-06-01-preview&lt;/code> or higher will not obliterate the service but put it into the soft-delete state. It can be restored or purged (deleted forever) from this state. If nothing is done, the APIM will purge itself after a specific time.&lt;/p>
&lt;p>&lt;img src="https://manualbashing.github.io/static/apim-meme.jpg" alt="">&lt;/p>
&lt;p>No need to mention that this is a valuable feature, but it has downsides too, that have caused people headaches: &lt;a href="https://github.com/Azure/azure-cli/issues/16138">APIM gets stuck in soft-delete state · Issue #16138 · Azure/azure-cli (github.com)&lt;/a>&lt;/p>
&lt;p>As far as I see it, the problem lies in a combination of three factors:&lt;/p>
&lt;ol>
&lt;li>Once soft-deleted, the name of the APIM is still reserved, and attempts to deploy an APIM with the same name will fail.&lt;/li>
&lt;li>Functionality to manage soft-deleted APIM instances has not yet (10th of Feb. 2022) been added to neither azure CLI nor the Azure portal.&lt;/li>
&lt;li>Deleting an APIM from the Azure Portal by either deleting it directly or removing its resource group will put it into the soft-delete state.&lt;/li>
&lt;/ol>
&lt;p>So far, the only way to manage a soft-deleted APIM is the Azure REST API: &lt;a href="https://docs.microsoft.com/en-us/rest/api/apimanagement/current-ga/deleted-services">Deleted Services - REST API (Azure API Management) | Microsoft Docs&lt;/a>&lt;/p>
&lt;p>Fortunately, the Azure REST API can be called directly from the Azure CLI using the &lt;code>az rest&lt;/code> namespace: &lt;a href="https://docs.microsoft.com/en-us/cli/azure/reference-index?view=azure-cli-latest#az-rest">az | Microsoft Docs&lt;/a>&lt;/p>
&lt;p>Here are some examples of how to manage soft-deleted APIM instances using the Azure REST API with Azure CLI:&lt;/p>
&lt;h2 id="list-all-soft-deleted-instances">List all soft-deleted instances&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span> &lt;span style="color:#b8860b">subscriptionId&lt;/span>&lt;span style="color:#666">=&lt;/span>&lt;span style="color:#a2f;font-weight:bold">$(&lt;/span>az account show --query id --output tsv&lt;span style="color:#a2f;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> az rest &lt;span style="color:#b62;font-weight:bold">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b62;font-weight:bold">&lt;/span> --method GET &lt;span style="color:#b62;font-weight:bold">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b62;font-weight:bold">&lt;/span> --header &lt;span style="color:#b44">&amp;#34;Accept=application/json&amp;#34;&lt;/span> &lt;span style="color:#b62;font-weight:bold">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b62;font-weight:bold">&lt;/span> --uri &lt;span style="color:#b44">&amp;#34;https://management.azure.com/subscriptions/&lt;/span>&lt;span style="color:#b68;font-weight:bold">${&lt;/span>&lt;span style="color:#b8860b">subscriptionId&lt;/span>&lt;span style="color:#b68;font-weight:bold">}&lt;/span>&lt;span style="color:#b44">/providers/Microsoft.ApiManagement/deletedservices?api-version=2021-08-01&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Source: &lt;a href="https://docs.microsoft.com/en-us/rest/api/apimanagement/current-ga/deleted-services/list-by-subscription">Deleted Services - List By Subscription - REST API (Azure API Management) | Microsoft Docs&lt;/a>&lt;/p>
&lt;h2 id="restore-a-soft-deleted-instance">Restore a soft-deleted instance&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b8860b">apimName&lt;/span>&lt;span style="color:#666">=&lt;/span>&lt;span style="color:#b44">&amp;#34;{ name of the APIM instance that you want to restore }&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b8860b">subscriptionId&lt;/span>&lt;span style="color:#666">=&lt;/span>&lt;span style="color:#a2f;font-weight:bold">$(&lt;/span>az account show --query id --output tsv&lt;span style="color:#a2f;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b8860b">location&lt;/span>&lt;span style="color:#666">=&lt;/span>&lt;span style="color:#b44">&amp;#34;{ location of the APIM} &amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b8860b">resourceGroupName&lt;/span>&lt;span style="color:#666">=&lt;/span>&lt;span style="color:#b44">&amp;#34;{ name of the resource group where the APIM resides }&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>az rest &lt;span style="color:#b62;font-weight:bold">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b62;font-weight:bold">&lt;/span> --method PUT &lt;span style="color:#b62;font-weight:bold">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b62;font-weight:bold">&lt;/span> --header &lt;span style="color:#b44">&amp;#34;Accept=application/json&amp;#34;&lt;/span> &lt;span style="color:#b62;font-weight:bold">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b62;font-weight:bold">&lt;/span> --uri &lt;span style="color:#b44">&amp;#34;https://management.azure.com/subscriptions/&lt;/span>&lt;span style="color:#b68;font-weight:bold">${&lt;/span>&lt;span style="color:#b8860b">subscriptionId&lt;/span>&lt;span style="color:#b68;font-weight:bold">}&lt;/span>&lt;span style="color:#b44">/resourceGroups/&lt;/span>&lt;span style="color:#b68;font-weight:bold">${&lt;/span>&lt;span style="color:#b8860b">resourceGroupName&lt;/span>&lt;span style="color:#b68;font-weight:bold">}&lt;/span>&lt;span style="color:#b44">/providers/Microsoft.ApiManagement/service/&lt;/span>&lt;span style="color:#b68;font-weight:bold">${&lt;/span>&lt;span style="color:#b8860b">apimName&lt;/span>&lt;span style="color:#b68;font-weight:bold">}&lt;/span>&lt;span style="color:#b44">?api-version=2021-08-01&amp;#34;&lt;/span> &lt;span style="color:#b62;font-weight:bold">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b62;font-weight:bold">&lt;/span> --body &lt;span style="color:#b44">&amp;#34;{\&amp;#34;location\&amp;#34;:\&amp;#34;&lt;/span>&lt;span style="color:#b68;font-weight:bold">${&lt;/span>&lt;span style="color:#b8860b">location&lt;/span>&lt;span style="color:#b68;font-weight:bold">}&lt;/span>&lt;span style="color:#b44">\&amp;#34;,\&amp;#34;properties\&amp;#34;: {\&amp;#34;restore\&amp;#34; : true} }&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#666">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Source: &lt;a href="https://docs.microsoft.com/en-us/rest/api/apimanagement/current-ga/api-management-service/create-or-update">Api Management Service - Create Or Update - REST API (Azure API Management) | Microsoft Docs&lt;/a>&lt;/p>
&lt;h2 id="purge-a-soft-deleted-instance">Purge a soft-deleted instance&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b8860b">apimName&lt;/span>&lt;span style="color:#666">=&lt;/span>&lt;span style="color:#b44">&amp;#34;{ name of the APIM instance that you want to purge }&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b8860b">subscriptionId&lt;/span>&lt;span style="color:#666">=&lt;/span>&lt;span style="color:#a2f;font-weight:bold">$(&lt;/span>az account show --query id --output tsv&lt;span style="color:#a2f;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b8860b">location&lt;/span>&lt;span style="color:#666">=&lt;/span>&lt;span style="color:#b44">&amp;#34;{ location where the APIM resides }&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#080;font-style:italic"># Here comes the actual call to the api to purge the APIM instance&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>az rest &lt;span style="color:#b62;font-weight:bold">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b62;font-weight:bold">&lt;/span> --method DELETE &lt;span style="color:#b62;font-weight:bold">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b62;font-weight:bold">&lt;/span> --header &lt;span style="color:#b44">&amp;#34;Accept=application/json&amp;#34;&lt;/span> &lt;span style="color:#b62;font-weight:bold">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b62;font-weight:bold">&lt;/span> --uri &lt;span style="color:#b44">&amp;#34;https://management.azure.com/subscriptions/&lt;/span>&lt;span style="color:#b68;font-weight:bold">${&lt;/span>&lt;span style="color:#b8860b">subscriptionId&lt;/span>&lt;span style="color:#b68;font-weight:bold">}&lt;/span>&lt;span style="color:#b44">/providers/Microsoft.ApiManagement/locations/&lt;/span>&lt;span style="color:#b68;font-weight:bold">${&lt;/span>&lt;span style="color:#b8860b">location&lt;/span>&lt;span style="color:#b68;font-weight:bold">}&lt;/span>&lt;span style="color:#b44">/deletedservices/&lt;/span>&lt;span style="color:#b68;font-weight:bold">${&lt;/span>&lt;span style="color:#b8860b">apimName&lt;/span>&lt;span style="color:#b68;font-weight:bold">}&lt;/span>&lt;span style="color:#b44">?api-version=2021-08-01&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Source: &lt;a href="https://docs.microsoft.com/en-us/azure/api-management/soft-delete#purge-a-soft-deleted-instance">Azure API Management soft-delete (preview) | Microsoft Docs&lt;/a>&lt;/p>
&lt;h2 id="derive-parameter-values-from-the-context">Derive parameter values from the context&lt;/h2>
&lt;p>Instead of setting all the required parameters manually, you can actually derive them from the context, if you specify the name of the APIM instance.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b8860b">apimName&lt;/span>&lt;span style="color:#666">=&lt;/span>&lt;span style="color:#b44">&amp;#34;{ name of the APIM instance }&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b8860b">subscriptionId&lt;/span>&lt;span style="color:#666">=&lt;/span>&lt;span style="color:#a2f;font-weight:bold">$(&lt;/span>az account show --query id --output tsv&lt;span style="color:#a2f;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b8860b">apimObj&lt;/span>&lt;span style="color:#666">=&lt;/span>&lt;span style="color:#a2f;font-weight:bold">$(&lt;/span>az rest &lt;span style="color:#b62;font-weight:bold">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b62;font-weight:bold">&lt;/span> --method GET &lt;span style="color:#b62;font-weight:bold">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b62;font-weight:bold">&lt;/span> --header &lt;span style="color:#b44">&amp;#34;Accept=application/json&amp;#34;&lt;/span> &lt;span style="color:#b62;font-weight:bold">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b62;font-weight:bold">&lt;/span> --uri &lt;span style="color:#b44">&amp;#34;https://management.azure.com/subscriptions/&lt;/span>&lt;span style="color:#b68;font-weight:bold">${&lt;/span>&lt;span style="color:#b8860b">subscriptionId&lt;/span>&lt;span style="color:#b68;font-weight:bold">}&lt;/span>&lt;span style="color:#b44">/providers/Microsoft.ApiManagement/deletedservices?api-version=2021-08-01&amp;#34;&lt;/span> &lt;span style="color:#b62;font-weight:bold">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b62;font-weight:bold">&lt;/span> --query &lt;span style="color:#b44">&amp;#34;value[?name == &amp;#39;&lt;/span>&lt;span style="color:#b68;font-weight:bold">${&lt;/span>&lt;span style="color:#b8860b">apimName&lt;/span>&lt;span style="color:#b68;font-weight:bold">}&lt;/span>&lt;span style="color:#b44">&amp;#39;]&amp;#34;&lt;/span>&lt;span style="color:#a2f;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#080;font-style:italic"># location will be converted to lowercase without spaces&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b8860b">location&lt;/span>&lt;span style="color:#666">=&lt;/span>&lt;span style="color:#a2f;font-weight:bold">$(&lt;/span>&lt;span style="color:#a2f">echo&lt;/span> &lt;span style="color:#b8860b">$apimObj&lt;/span> |
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> jq -r &lt;span style="color:#b44">&amp;#39;.[].location&amp;#39;&lt;/span> |
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sed -e &lt;span style="color:#b44">&amp;#39;s/./\L&amp;amp;/g&amp;#39;&lt;/span> -e &lt;span style="color:#b44">&amp;#39;s/ //g&amp;#39;&lt;/span>&lt;span style="color:#a2f;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b8860b">resourceGroupName&lt;/span>&lt;span style="color:#666">=&lt;/span>&lt;span style="color:#a2f;font-weight:bold">$(&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a2f">echo&lt;/span> &lt;span style="color:#b8860b">$apimObj&lt;/span> |
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> jq -r &lt;span style="color:#b44">&amp;#39;.[].properties.serviceId&amp;#39;&lt;/span> |
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sed -E &lt;span style="color:#b44">&amp;#39;s|.*resourceGroups/([^/]+).*|\1|g&amp;#39;&lt;/span>&lt;span style="color:#a2f;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>dotnet build would fail for an angular app if nodejs were installed using asdf</title><link>https://manualbashing.github.io/posts/dotnet-build-fails-for-angular-app-if-nodejs-was-installed-using-asdf/</link><pubDate>Thu, 24 Jun 2021 00:00:00 +0000</pubDate><guid>https://manualbashing.github.io/posts/dotnet-build-fails-for-angular-app-if-nodejs-was-installed-using-asdf/</guid><description>&lt;p>I was creating a new angular project using a template via &lt;a href="https://docs.microsoft.com/en-us/dotnet/core/tools/">dotnet cli&lt;/a> today:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>dotnet new angular
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Id did not have Node.js installed, so I installed it using &lt;a href="https://asdf-vm.com/">asdf&lt;/a>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>asdf plugin add nodejs
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>asdf install nodejs latest
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This successfully installed Node.js &lt;code>v16.4.0&lt;/code>. But when I tried to build the example project using &lt;code>dotnet build&lt;/code>, I ran into the following error:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>❯ dotnet build
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Microsoft &lt;span style="color:#666">(&lt;/span>R&lt;span style="color:#666">)&lt;/span> Build Engine version 16.7.2+b60ddb6f4 &lt;span style="color:#a2f;font-weight:bold">for&lt;/span> .NET
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Copyright &lt;span style="color:#666">(&lt;/span>C&lt;span style="color:#666">)&lt;/span> Microsoft Corporation. All rights reserved.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Determining projects to restore...
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> All projects are up-to-date &lt;span style="color:#a2f;font-weight:bold">for&lt;/span> restore.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> foo -&amp;gt; /home/mbatsching/git/foo/bin/Debug/netcoreapp3.1/foo.dll
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> foo -&amp;gt; /home/mbatsching/git/foo/bin/Debug/netcoreapp3.1/foo.Views.dll
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> No version &lt;span style="color:#a2f">set&lt;/span> &lt;span style="color:#a2f;font-weight:bold">for&lt;/span> &lt;span style="color:#a2f">command&lt;/span> node
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Consider adding one of the following versions in your config file at
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> nodejs 16.4.0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>/home/mbatsching/git/foo/foo.csproj&lt;span style="color:#666">(&lt;/span>28,5&lt;span style="color:#666">)&lt;/span>: warning MSB3073: The &lt;span style="color:#a2f">command&lt;/span> &lt;span style="color:#b44">&amp;#34;node --version&amp;#34;&lt;/span> exited with code 126.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>/home/mbatsching/git/foo/foo.csproj&lt;span style="color:#666">(&lt;/span>28,5&lt;span style="color:#666">)&lt;/span>: warning MSB4181: The &lt;span style="color:#b44">&amp;#34;Exec&amp;#34;&lt;/span> task returned &lt;span style="color:#a2f">false&lt;/span> but did not log an error.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>/home/mbatsching/git/foo/foo.csproj&lt;span style="color:#666">(&lt;/span>31,5&lt;span style="color:#666">)&lt;/span>: error : Node.js is required to build and run this project. To &lt;span style="color:#a2f;font-weight:bold">continue&lt;/span>, please install Node.js from https://nodejs.org/, and &lt;span style="color:#a2f;font-weight:bold">then&lt;/span> restart your &lt;span style="color:#a2f">command&lt;/span> prompt or IDE.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>No version set for command &lt;code>node&lt;/code>?  That error is produced by the shim that asdf creates for the node executable. It needs to know which version of Node.js should be used in the current project.&lt;/p>
&lt;p>This can be done by creating a file named &lt;code>.tool-versions&lt;/code> in the project root and adding the Node.js version that should be used. In my case, the content of this file looked like this:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-text" data-lang="text">&lt;span style="display:flex;">&lt;span>nodejs 16.4.0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>After creating this file, the &lt;code>dotnet build&lt;/code> command was executed without issues.&lt;/p>
&lt;p>You can learn more about the &lt;code>.tool-versions&lt;/code> configuration file here: &lt;a href="https://asdf-vm.com/#/core-configuration?id=tool-versions">Configuration (asdf-vm.com)&lt;/a>&lt;/p>
&lt;hr>
&lt;p>&lt;strong>And by the way&amp;hellip; 🧐&lt;/strong>&lt;/p>
&lt;p>&lt;a href="https://www.youtube.com/watch?v=kcNpBNpvyc4&amp;amp;t=258s&amp;amp;ab_channel=TomSkaTomSkaVerified">asdf&lt;/a> is also the name of a legendary series of animated short films by TomSka.&lt;/p>
&lt;p>&lt;img src="https://manualbashing.github.io/static/asdf.gif" alt="">&lt;/p></description></item><item><title>About</title><link>https://manualbashing.github.io/about/</link><pubDate>Sun, 20 Aug 2017 00:00:00 +0000</pubDate><guid>https://manualbashing.github.io/about/</guid><description>&lt;p>&lt;img src="https://manualbashing.github.io/static/profile.png" alt="">&lt;/p>
&lt;p>Hi there, I&amp;rsquo;m Manuel. I currently work as an Application Developer, Cloud Solution Architect and DevOps Engineer at &lt;a href="https://abtis.de">abtis GmbH&lt;/a> in Pforzheim, Germany.&lt;/p>
&lt;p>This blog is my irregularly updated public notebook of bits and pieces of knowledge that I find interesting or useful in the work that I do.&lt;/p>
&lt;p>You can find me also on &lt;a href="https://twitter.com/manualbashing">Twitter&lt;/a>.&lt;/p></description></item></channel></rss>